<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Voting</title>
    <!-- FingerprintJS for device identification -->
    <script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            red: '#e21b3c',
                            blue: '#1368ce',
                            yellow: '#ffa602',
                            green: '#26890c',
                            dark: '#18181b', // Zinc 900
                            card: '#27272a', // Zinc 800
                        }
                    }
                }
            }
        }
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Custom Range Slider - Wider and thicker */
        .range-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 36px; /* Really thick track */
            border-radius: 12px;
            outline: none;
            transition: opacity 0.2s;
            cursor: pointer;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 44px; 
            height: 44px;
            background: white;
            cursor: pointer;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s ease;
            margin-top: -4px; /* Center thumb on the 36px track ((36-44)/2) */
        }
        
        .dark .range-slider::-webkit-slider-thumb {
             border-color: #f4f4f5; /* Zinc 100 border for thumb in dark mode */
        }

        .range-slider::-webkit-slider-thumb:active {
            transform: scale(1.15);
        }
        
        /* Integrated Input styling */
        .integrated-input-group:focus-within {
            border-color: #3b82f6;
            ring: 2px solid #3b82f6;
        }

        /* Custom Select styling */
        select.network-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="bg-zinc-100 dark:bg-zinc-950 text-zinc-900 dark:text-white transition-colors duration-300 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const socket = (typeof io !== 'undefined') ? io() : {
            on: (e, fn) => console.log(`[Mock Socket] Listening: ${e}`),
            emit: (e, d) => console.log(`[Mock Socket] Emitting: ${e}`, d),
            off: () => {}
        };

        // --- Fingerprint + LocalStorage Logic ---
        async function getDeviceId() {
            // 1. Check LocalStorage
            let deviceId = localStorage.getItem('grading_app_device_id');
            if (deviceId) return deviceId;

            // 2. Generate new via FingerprintJS
            try {
                if (window.FingerprintJS) {
                    const fp = await window.FingerprintJS.load();
                    const result = await fp.get();
                    deviceId = result.visitorId;
                } else {
                    // Fallback
                    deviceId = 'unknown-' + Math.random().toString(36).substring(7);
                }
            } catch (error) {
                console.error("Fingerprint Error:", error);
                deviceId = 'error-' + Math.random().toString(36).substring(7);
            }

            // 3. Save and Return
            localStorage.setItem('grading_app_device_id', deviceId);
            return deviceId;
        }

        // Identify immediately on connection
        socket.on('connect', async () => {
            const deviceId = await getDeviceId();
            socket.emit('client-identify', deviceId);
        });

        const { useState, useEffect, useMemo } = React;

        // Icons
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>;
        const IconPlay = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="m7 3 14 9-14 9V3z"/></svg>;
        const IconStop = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><rect width="14" height="14" x="5" y="5" rx="2"/></svg>;
        const IconMaximize = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>;
        const IconSun = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>;
        const IconMoon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
        const IconArrowRight = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>;
        const IconArrowLeft = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>;
        const IconList = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>;
        const IconAlert = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>;

        const COLORS = ['bg-brand-red', 'bg-brand-blue', 'bg-brand-yellow', 'bg-brand-green'];
        const HEX_COLORS = ['#e21b3c', '#1368ce', '#ffa602', '#26890c'];

        // Mock Data Update to include Network Names
        const mockGameState = {
            sessionId: 'AB12',
            isVotingOpen: false,
            currentSubject: '',
            currentParticipants: [],
            votingMode: 'group',
            availableIps: [
                { name: 'Loading...', url: '#' }
            ],
            votes: [],
            categories: [],
            name: 'Demo Session',
            connectedClients: 0,
            lastSessionClientCount: 0
        };

        function ThemeToggle({ isDark, toggle }) {
            return (
                <button 
                    onClick={toggle}
                    className="fixed top-4 right-4 z-50 p-3 rounded-xl bg-white dark:bg-zinc-800 text-zinc-900 dark:text-white border-b-4 border-zinc-200 dark:border-zinc-900 active:border-b-0 active:translate-y-1 transition-all"
                    title="Toggle Theme"
                >
                    {isDark ? <IconSun /> : <IconMoon />}
                </button>
            );
        }

        function ErrorModal({ message, onClose }) {
            if (!message) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fadeIn p-4">
                    <div className="bg-white dark:bg-zinc-900 rounded-3xl p-8 max-w-sm w-full shadow-2xl border-b-8 border-red-500 transform transition-all scale-100">
                        <div className="flex flex-col items-center text-center">
                            <div className="bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 p-4 rounded-full mb-4">
                                <IconAlert />
                            </div>
                            <h3 className="text-2xl font-black text-zinc-900 dark:text-white mb-2">Oops!</h3>
                            <p className="text-zinc-600 dark:text-zinc-300 font-medium mb-6">{message}</p>
                            <button 
                                onClick={onClose}
                                className="w-full bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 font-bold py-3 rounded-xl hover:opacity-90 transition"
                            >
                                Got it
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        /**
         * Reusable Results Component
         * Used by both Host and Student views
         */
        function ResultsView({ gameState, onClose }) {
            // Group all votes by Main Subject -> Sub Subject
            const summaryData = {};
            (gameState.votes || []).forEach(vote => {
                if (!summaryData[vote.mainSubject]) summaryData[vote.mainSubject] = {};
                if (!summaryData[vote.mainSubject][vote.subject]) summaryData[vote.mainSubject][vote.subject] = [];
                summaryData[vote.mainSubject][vote.subject].push(vote);
            });

            return (
                <div className="fixed inset-0 z-[60] min-h-screen bg-zinc-100 dark:bg-zinc-950 p-6 md:p-8 overflow-y-auto animate-fadeIn">
                     <header className="flex justify-between items-center mb-8 max-w-7xl mx-auto w-full">
                        <div>
                            <h1 className="text-3xl md:text-4xl font-black text-zinc-900 dark:text-white mb-2">Session Results</h1>
                            <p className="text-zinc-500 text-lg font-medium">Classroom Performance Summary</p>
                        </div>
                        <button 
                            onClick={onClose}
                            className="bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 px-8 py-3 rounded-xl font-bold text-lg hover:opacity-90 transition shadow-lg"
                        >
                            Close
                        </button>
                    </header>

                    <div className="grid grid-cols-1 gap-6 max-w-7xl mx-auto pb-20">
                        {Object.keys(summaryData).length === 0 && (
                            <div className="text-center py-20 text-zinc-400 font-bold text-xl">No votes recorded yet.</div>
                        )}

                        {Object.entries(summaryData).map(([mainSubject, subSubjects]) => {
                            // Calculate Overall Group Score
                            let groupTotalSum = 0;
                            let groupTotalCount = 0;
                            
                            Object.values(subSubjects).forEach(votes => {
                                votes.forEach(v => {
                                    gameState.categories.forEach(cat => {
                                         groupTotalSum += parseFloat(v.scores[cat.id] || 0);
                                         groupTotalCount++;
                                    });
                                });
                            });

                            const groupOverallAverage = groupTotalCount ? (groupTotalSum / groupTotalCount).toFixed(2) : "0.00";

                            return (
                            <div key={mainSubject} className="bg-white dark:bg-zinc-900 rounded-2xl p-6 border border-zinc-200 dark:border-zinc-800 shadow-sm">
                                <div className="flex flex-col md:flex-row md:items-center justify-between border-b border-zinc-100 dark:border-zinc-800 pb-4 mb-4 gap-4">
                                    <h2 className="text-2xl font-black text-zinc-900 dark:text-white">{mainSubject}</h2>
                                    <div className="flex items-center gap-3">
                                        <span className="text-zinc-400 text-sm font-bold uppercase tracking-wider">Overall Group Score</span>
                                        <span className="bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 px-4 py-2 rounded-lg font-black text-xl">{groupOverallAverage}</span>
                                    </div>
                                </div>
                                
                                <div className="flex flex-col gap-2">
                                    {/* Table Header */}
                                    <div className="grid grid-cols-12 gap-4 px-4 py-2 text-xs font-bold text-zinc-400 uppercase tracking-wider hidden md:grid">
                                        <div className="col-span-3">Participant / Item</div>
                                        <div className="col-span-7">Category Breakdown</div>
                                        <div className="col-span-2 text-right">Average</div>
                                    </div>

                                    {Object.entries(subSubjects).map(([subName, votes]) => {
                                        // Calculate average for this sub-item
                                        let totalSum = 0;
                                        const catScores = {};
                                        
                                        votes.forEach(v => {
                                            gameState.categories.forEach(cat => {
                                                const s = parseFloat(v.scores[cat.id] || 0);
                                                catScores[cat.id] = (catScores[cat.id] || 0) + s;
                                                totalSum += s;
                                            });
                                        });
                                        
                                        const catAvgs = gameState.categories.map(cat => ({
                                            ...cat,
                                            avg: (catScores[cat.id] / votes.length).toFixed(1)
                                        }));

                                        const totalAvg = (totalSum / (votes.length * gameState.categories.length)).toFixed(2);

                                        // Display Name Cleanup
                                        let displayName = subName;
                                        if (subName === mainSubject || subName === `${mainSubject} (Group)`) displayName = "Group Evaluation";
                                        else displayName = subName.replace(`${mainSubject} - `, '');

                                        return (
                                            <div key={subName} className="bg-zinc-50 dark:bg-zinc-950/30 rounded-xl p-4 md:grid md:grid-cols-12 md:gap-4 md:items-center hover:bg-zinc-100 dark:hover:bg-zinc-800/50 transition border border-transparent hover:border-zinc-200 dark:hover:border-zinc-700">
                                                
                                                {/* Name */}
                                                <div className="md:col-span-3 flex justify-between md:block mb-2 md:mb-0">
                                                    <h3 className="text-lg font-bold text-zinc-800 dark:text-zinc-200">{displayName}</h3>
                                                    <span className="md:hidden text-xs font-bold bg-zinc-200 dark:bg-zinc-800 px-2 py-1 rounded text-zinc-500">{votes.length} votes</span>
                                                </div>

                                                {/* Scores Breakdown */}
                                                <div className="md:col-span-7 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-2 mb-3 md:mb-0">
                                                    {catAvgs.map((cat, i) => (
                                                        <div key={cat.id} className="flex items-center gap-2">
                                                            <div className={`w-2 h-2 rounded-full ${COLORS[i % COLORS.length]} flex-shrink-0`}></div>
                                                            <span className="text-xs font-bold text-zinc-500 truncate max-w-[80px]">{cat.name}:</span>
                                                            <span className="text-sm font-black text-zinc-900 dark:text-white">{cat.avg}</span>
                                                        </div>
                                                    ))}
                                                </div>

                                                {/* Total Average */}
                                                <div className="md:col-span-2 flex items-center justify-between md:justify-end gap-4 border-t md:border-t-0 border-zinc-100 dark:border-zinc-800 pt-2 md:pt-0">
                                                     <span className="md:hidden text-xs font-bold text-zinc-400 uppercase">Total Score</span>
                                                     <div className="flex items-center gap-3">
                                                        <span className="hidden md:inline text-xs font-bold text-zinc-300">{votes.length} votes</span>
                                                        <span className="text-xl font-black text-blue-600 dark:text-blue-400 tabular-nums">{totalAvg}</span>
                                                     </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )})}
                    </div>
                </div>
            );
        }

        function App() {
            const [view, setView] = useState('loading');
            const [gameState, setGameState] = useState(null);
            const [isDark, setIsDark] = useState(true);
            const [errorMessage, setErrorMessage] = useState(null);

            useEffect(() => {
                if (isDark) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }, [isDark]);

            useEffect(() => {
                // If no socket, use mock data slightly delayed
                if (typeof io === 'undefined') {
                    setTimeout(() => setGameState(mockGameState), 500);
                }
                
                socket.on('state-update', (data) => setGameState(data));
                socket.on('error-message', (msg) => setErrorMessage(msg));

                return () => {
                    socket.off('state-update');
                    socket.off('error-message');
                };
            }, []);

            useEffect(() => {
                if (!gameState) return;
                
                const isHost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                if (isHost) {
                    setView(gameState.sessionId ? 'host' : 'setup');
                } else {
                    setView('student');
                }
            }, [gameState]);

            return (
                <>
                    <ThemeToggle isDark={isDark} toggle={() => setIsDark(!isDark)} />
                    <ErrorModal message={errorMessage} onClose={() => setErrorMessage(null)} />
                    
                    {view === 'loading' && <div className="min-h-screen flex items-center justify-center text-zinc-400 font-bold uppercase tracking-widest text-xs">Connecting...</div>}
                    {view === 'setup' && <HostSetup onStart={(data) => {
                        const newState = { ...mockGameState, ...data, sessionId: 'AB12', votes: [] }; 
                        setGameState(newState); 
                        socket.emit('host-create-session', data)
                    }} />}
                    {view === 'host' && <HostDashboard gameState={gameState} />}
                    {view === 'student' && <StudentView gameState={gameState} isDark={isDark} />}
                </>
            );
        }

        function HostSetup({ onStart }) {
            const [name, setName] = useState('Morning Session');
            const [categories, setCategories] = useState([
                { id: 1, name: 'Creativity', min: 1, max: 10 },
                { id: 2, name: 'Delivery', min: 1, max: 10 }
            ]);
            
            const addCat = () => setCategories([...categories, { id: Date.now(), name: '', min: 1, max: 10 }]);
            const removeCat = (id) => {
                if (categories.length > 1) setCategories(categories.filter(c => c.id !== id));
            };
            const updateCat = (i, field, val) => { const n = [...categories]; n[i][field] = val; setCategories(n); };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-zinc-100 dark:bg-zinc-950">
                    <div className="w-full max-w-2xl bg-white dark:bg-zinc-900 rounded-3xl border border-zinc-200 dark:border-zinc-800 p-8 md:p-10 animate-fadeIn">
                        <h2 className="text-3xl font-black mb-8 text-zinc-900 dark:text-white tracking-tight">Session Setup</h2>
                        <div className="space-y-8">
                            <div>
                                <label className="block text-xs font-bold text-zinc-500 dark:text-zinc-400 uppercase tracking-wider mb-2">Session Name</label>
                                <input 
                                    value={name} 
                                    onChange={e => setName(e.target.value)} 
                                    className="w-full bg-zinc-50 dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 p-4 rounded-xl font-bold text-lg outline-none focus:border-blue-500 dark:text-white transition focus:ring-4 ring-blue-500/10" 
                                />
                            </div>
                            
                            <div>
                                <label className="block text-xs font-bold text-zinc-500 dark:text-zinc-400 uppercase tracking-wider mb-4">Grading Criteria</label>
                                <div className="space-y-4">
                                    {categories.map((cat, i) => (
                                        <div key={cat.id} className="flex flex-col md:flex-row gap-4 items-start md:items-center bg-zinc-50 dark:bg-zinc-950/50 p-4 rounded-2xl border border-zinc-100 dark:border-zinc-800">
                                            <div className={`w-3 h-3 rounded-full mt-2 md:mt-0 ${COLORS[i % COLORS.length]}`}></div>
                                            <input 
                                                placeholder="Criterion Name" 
                                                value={cat.name} 
                                                onChange={e => updateCat(i, 'name', e.target.value)} 
                                                className="flex-1 bg-transparent border-b-2 border-zinc-200 dark:border-zinc-800 p-2 font-bold text-zinc-700 dark:text-white outline-none focus:border-blue-500 transition w-full md:w-auto" 
                                            />
                                            
                                            {/* Integrated Min/Max Control */}
                                            <div className="flex bg-white dark:bg-zinc-900 rounded-lg overflow-hidden border border-zinc-200 dark:border-zinc-800 integrated-input-group">
                                                <div className="flex flex-col border-r border-zinc-100 dark:border-zinc-800 px-3 py-1">
                                                    <span className="text-[9px] font-bold text-zinc-400 uppercase">Min</span>
                                                    <input type="number" value={cat.min} onChange={e => updateCat(i, 'min', parseInt(e.target.value))} className="w-12 bg-transparent text-center text-sm font-bold outline-none dark:text-white" />
                                                </div>
                                                <div className="flex flex-col px-3 py-1">
                                                    <span className="text-[9px] font-bold text-zinc-400 uppercase">Max</span>
                                                    <input type="number" value={cat.max} onChange={e => updateCat(i, 'max', parseInt(e.target.value))} className="w-12 bg-transparent text-center text-sm font-bold outline-none dark:text-white" />
                                                </div>
                                            </div>

                                            {categories.length > 1 && (
                                                <button onClick={() => removeCat(cat.id)} className="p-2 text-zinc-400 hover:text-red-500 transition">
                                                    <IconTrash />
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                                <button onClick={addCat} className="mt-4 text-blue-600 dark:text-blue-400 text-sm font-bold hover:underline tracking-wide flex items-center gap-2">
                                    <span className="bg-blue-100 dark:bg-blue-900/30 w-5 h-5 flex items-center justify-center rounded text-xs">+</span> Add Criterion
                                </button>
                            </div>

                            <button 
                                onClick={() => onStart({ name, categories })} 
                                className="w-full bg-zinc-900 dark:bg-blue-600 hover:bg-black dark:hover:bg-blue-500 text-white py-5 rounded-2xl font-black text-lg transition-all border-zinc-950 dark:border-blue-800 mt-4"
                            >
                                LAUNCH SESSION
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        function HostDashboard({ gameState }) {
            const [groupCounter, setGroupCounter] = useState(1);
            const [nextSubject, setNextSubject] = useState('Grupo 1');
            const [participantsText, setParticipantsText] = useState('');
            const [votingMode, setVotingMode] = useState('group'); // group, mixed, participants
            const [showBigIp, setShowBigIp] = useState(false);
            const [showSummary, setShowSummary] = useState(false);
            const [ipIndex, setIpIndex] = useState(0);

            // Filter votes for current MAIN subject (Group Name)
            // Note: In server we store mainSubject. Client receives 'votes'.
            const currentVotes = (gameState.votes || []).filter(v => v.mainSubject === gameState.currentSubject);
            
            // Calculate unique voters
            const uniqueVoters = new Set(currentVotes.map(v => v.clientId)).size;
            
            // Get Total Clients - Subtract 1 for Host (Teacher)
            // If gameState.connectedClients is undefined (mock), default to 1 so subtraction gives 0 students
            const totalConnections = gameState.connectedClients || 1;
            
            // If voting is open, use LIVE count. If closed, use HISTORICAL snapshot.
            // Fallback to totalConnections if historical is missing (legacy)
            const activeTotal = gameState.isVotingOpen ? totalConnections : (gameState.lastSessionClientCount || totalConnections);
            
            const studentCount = Math.max(0, activeTotal - 1);
            const liveStudentCount = Math.max(0, totalConnections - 1); // Always need live for the 'Connected' badge

            // Live Update Fix:
            // Regardless of voting mode, we want to show the aggregate "Group Grade" on the main screen.
            // If it's "Participants Only", we take ALL votes for this main subject and average them.
            // This represents the "Whole Group" performance.
            const allSubjectVotes = currentVotes; // Includes all sub-subjects/participants for this group
            
            const averages = gameState.categories.map(cat => {
                let sum = 0, count = 0;
                allSubjectVotes.forEach(v => { 
                    if (v.scores[cat.id]) { 
                        sum += parseFloat(v.scores[cat.id]); 
                        count++; 
                    } 
                });
                return { ...cat, avg: count ? (sum/count).toFixed(1) : "0.0" };
            });

            const ips = gameState.availableIps || [{ name: 'Localhost', url: 'http://localhost:3000' }];
            const currentIp = ips[ipIndex] || ips[0];

            const startVote = () => {
                if(!nextSubject && !gameState.currentSubject) return;
                
                const participants = participantsText.split(/[\n,]/).map(p => p.trim()).filter(p => p);
                const subject = nextSubject || gameState.currentSubject;

                socket.emit('host-update-status', { 
                    isVotingOpen: true, 
                    currentSubject: subject,
                    currentParticipants: participants,
                    votingMode: votingMode
                }); 
                
                // Prepare next group
                const nextNum = groupCounter + 1;
                setGroupCounter(nextNum);
                setNextSubject(`Grupo ${nextNum}`);
                setParticipantsText('');
                setShowSummary(false);
            };

            // Full screen voting view - Light/Dark Mode Supported
            if (gameState.isVotingOpen) {
                return (
                    <div className="min-h-screen bg-zinc-50 dark:bg-zinc-950 text-zinc-900 dark:text-white flex flex-col animate-fadeIn transition-colors">
                        {/* Header */}
                        <header className="p-10 flex justify-between items-start border-b border-zinc-200 dark:border-zinc-800 bg-white/50 dark:bg-zinc-900/50 backdrop-blur-sm">
                            <div className="max-w-4xl">
                                <h1 className="text-6xl md:text-8xl font-black tracking-tight leading-tight">{gameState.currentSubject}</h1>
                                {gameState.votingMode !== 'group' && (
                                    <div className="text-zinc-500 dark:text-zinc-400 font-bold text-2xl mt-4 flex gap-4">
                                        <span className="bg-zinc-200 dark:bg-zinc-800 px-4 py-2 rounded-lg">{gameState.currentParticipants.length} Participants</span>
                                        <span className="bg-zinc-200 dark:bg-zinc-800 px-4 py-2 rounded-lg capitalize">Mode: {gameState.votingMode}</span>
                                    </div>
                                )}
                            </div>
                            <button 
                                onClick={() => socket.emit('host-update-status', { isVotingOpen: false })} 
                                className="bg-red-600 hover:bg-red-500 text-white px-10 py-6 rounded-3xl font-black text-2xl flex items-center gap-4 transition-all shadow-lg"
                            >
                                <IconStop /> END VOTING
                            </button>
                        </header>

                        {/* Main Content: Huge Stats & Bars for Big Screen */}
                        <div className="flex-1 flex flex-col md:flex-row items-center justify-center p-12 gap-16 md:gap-32">
                            
                            {/* Huge Vote Counter */}
                            <div className="text-center animate-fadeIn">
                                <div className="text-[12rem] leading-none font-black text-zinc-900 dark:text-white tabular-nums tracking-tighter flex items-baseline">
                                    {uniqueVoters}
                                    <span className="text-[6rem] text-zinc-300 dark:text-zinc-700 ml-4">/{studentCount}</span>
                                </div>
                                <div className="text-zinc-500 font-black uppercase tracking-[0.2em] text-2xl mt-4">Voters</div>
                            </div>

                            {/* Huge Bars (Show Group Averages) */}
                            <div className="w-full max-w-4xl space-y-12">
                                <div className="text-zinc-500 font-bold uppercase tracking-widest mb-4">
                                    {gameState.votingMode === 'group' ? 'Live Group Averages' : 'Live Group Aggregate'}
                                </div>
                                {averages.map((cat, i) => (
                                    <div key={cat.id} className="relative">
                                        <div className="flex justify-between items-end mb-4">
                                            <span className="text-3xl font-bold text-zinc-700 dark:text-zinc-300">{cat.name}</span>
                                            <span className="text-4xl font-black tabular-nums text-zinc-900 dark:text-white">{cat.avg}</span>
                                        </div>
                                        <div className="h-12 bg-zinc-200 dark:bg-zinc-900 rounded-full overflow-hidden border border-zinc-300 dark:border-zinc-800">
                                            <div 
                                                className={`h-full ${COLORS[i % COLORS.length]} transition-all duration-700 cubic-bezier(0.4, 0, 0.2, 1) relative`}
                                                style={{ width: `${(parseFloat(cat.avg) / cat.max) * 100}%` }}
                                            >
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            // SUMMARY VIEW (Shown when user clicks "View Results" or End Session)
            if (showSummary) {
                return <ResultsView gameState={gameState} onClose={() => setShowSummary(false)} />;
            }

            // Dashboard View
            return (
                <div className="min-h-screen p-8 md:p-12 transition-colors bg-zinc-100 dark:bg-zinc-950">
                    {showBigIp && (
                        <div className="fixed inset-0 z-50 bg-zinc-950/40 backdrop-blur-3xl flex flex-col items-center justify-center p-8 animate-fadeIn cursor-pointer" onClick={() => setShowBigIp(false)}>
                            <span className="text-zinc-600 dark:text-zinc-400 font-bold uppercase tracking-widest text-xl mb-12">Join at this URL</span>
                            <div className="bg-white dark:bg-zinc-900 p-6 rounded-2xl mb-6 text-zinc-600 dark:text-zinc-400 font-bold text-xl uppercase tracking-widest border border-zinc-200 dark:border-zinc-800 shadow-xl">
                                Network: {currentIp.name || 'Unknown'}
                            </div>
                            <h2 className="text-5xl md:text-8xl font-black text-zinc-900 dark:text-white tracking-tight break-all text-center mb-16 drop-shadow-sm">
                                {currentIp.url.replace(/^https?:\/\//, '')}
                            </h2>
                            <p className="text-zinc-500 font-bold uppercase tracking-widest text-lg">Click to close</p>
                        </div>
                    )}

                    <div className="max-w-[90rem] mx-auto">
                        <header className="flex flex-col md:flex-row justify-between items-start md:items-end mb-16 gap-8">
                            <div>
                                <h1 className="text-6xl font-black tracking-tight mb-4 dark:text-white">{gameState.name}</h1>
                                <div className="flex flex-col md:flex-row gap-4 items-start md:items-center">
                                    <span className="text-zinc-500 dark:text-zinc-400 font-mono text-lg uppercase bg-zinc-200 dark:bg-zinc-900 px-4 py-2 rounded-xl inline-block font-bold">
                                        Room: {gameState.sessionId}
                                    </span>
                                    {/* Network Dropdown */}
                                    <div className="relative">
                                        <select 
                                            value={ipIndex} 
                                            onChange={(e) => setIpIndex(Number(e.target.value))}
                                            className="network-select appearance-none bg-zinc-200 dark:bg-zinc-900 text-zinc-700 dark:text-zinc-300 font-bold text-lg py-2 pl-4 pr-10 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 border border-transparent"
                                        >
                                            {ips.map((ip, idx) => (
                                                <option key={idx} value={idx}>{ip.name || `Network ${idx + 1}`} - {ip.url}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-6 w-full md:w-auto">
                                <button onClick={() => setShowBigIp(true)} className="flex-1 md:flex-none bg-white dark:bg-zinc-800 border-2 border-zinc-200 dark:border-zinc-800 px-8 py-4 rounded-2xl font-bold text-lg flex items-center justify-center gap-3 transition hover:-translate-y-1 active:translate-y-0 dark:text-white">
                                    <IconMaximize /> SHOW LINK
                                </button>
                                <button onClick={() => setShowSummary(true)} className="flex-1 md:flex-none bg-white dark:bg-zinc-800 border-2 border-zinc-200 dark:border-zinc-800 px-8 py-4 rounded-2xl font-bold text-lg flex items-center justify-center gap-3 transition hover:-translate-y-1 active:translate-y-0 dark:text-white">
                                    <IconList /> RESULTS
                                </button>
                                <a href="/export" target="_blank" className="flex-1 md:flex-none bg-zinc-900 dark:bg-white text-white dark:text-zinc-900 border-2 border-black dark:border-zinc-200 px-8 py-4 rounded-2xl font-bold text-lg hover:-translate-y-1 active:translate-y-0 transition text-center flex items-center justify-center">
                                    EXPORT DATA
                                </a>
                            </div>
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-12">
                            {/* Control Panel - Upscaled */}
                            <div className="lg:col-span-4 bg-white dark:bg-zinc-900 rounded-[2.5rem] p-10 border border-zinc-200 dark:border-zinc-800 h-fit">
                                <h3 className="text-sm font-black text-zinc-400 uppercase tracking-widest mb-8">Start Vote</h3>
                                <div className="space-y-6">
                                    <div>
                                        <label className="block text-sm font-bold text-zinc-500 mb-3 uppercase">Group Name</label>
                                        <input 
                                            value={nextSubject} 
                                            onChange={e => setNextSubject(e.target.value)}
                                            placeholder="e.g. Grupo 1"
                                            className="w-full bg-zinc-100 dark:bg-zinc-950 border-2 border-transparent focus:border-blue-500 dark:text-white p-6 rounded-2xl font-bold text-2xl outline-none transition"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-bold text-zinc-500 mb-3 uppercase">Voting Mode</label>
                                        <select
                                            value={votingMode}
                                            onChange={(e) => setVotingMode(e.target.value)}
                                            className="w-full bg-zinc-100 dark:bg-zinc-950 text-zinc-900 dark:text-white p-6 rounded-2xl font-bold text-xl outline-none border-2 border-transparent focus:border-blue-500 appearance-none network-select"
                                        >
                                            <option value="group">Group Only</option>
                                            <option value="mixed">Group + Participants</option>
                                            <option value="participants">Participants Only</option>
                                        </select>
                                    </div>

                                    {votingMode !== 'group' && (
                                        <div className="animate-fadeIn">
                                            <label className="block text-sm font-bold text-zinc-500 mb-3 uppercase">Participants (One per line)</label>
                                            <textarea 
                                                value={participantsText} 
                                                onChange={e => setParticipantsText(e.target.value)}
                                                placeholder="Alice&#10;Bob&#10;Charlie"
                                                className="w-full h-32 bg-zinc-100 dark:bg-zinc-950 border-2 border-transparent focus:border-blue-500 dark:text-white p-4 rounded-2xl font-bold text-lg outline-none transition resize-none"
                                            />
                                        </div>
                                    )}

                                    <button 
                                        onClick={startVote}
                                        className="w-full bg-blue-600 hover:bg-blue-500 text-white py-8 rounded-2xl font-black text-2xl flex justify-center items-center gap-4 transition-all mt-4"
                                    >
                                        <IconPlay /> START
                                    </button>
                                </div>
                            </div>

                            {/* Results Panel */}
                            <div className="lg:col-span-8 bg-white dark:bg-zinc-900 rounded-[2.5rem] p-10 border border-zinc-200 dark:border-zinc-800 min-h-[500px]">
                                <h3 className="text-sm font-black text-zinc-400 uppercase tracking-widest mb-10">Latest Results</h3>
                                {gameState.currentSubject ? (
                                    <div className="space-y-10 animate-fadeIn">
                                        <div className="flex justify-between items-baseline border-b-2 border-zinc-100 dark:border-zinc-800 pb-8">
                                            <div>
                                                <h4 className="text-5xl font-black text-zinc-900 dark:text-white">{gameState.currentSubject}</h4>
                                                <div className="mt-2 text-zinc-500 font-bold">{gameState.votingMode !== 'group' ? 'Multi-part Assessment' : 'Group Assessment'}</div>
                                            </div>
                                            <div className="flex flex-col items-end gap-2">
                                                <span className="bg-zinc-100 dark:bg-zinc-800 text-zinc-900 dark:text-white px-6 py-2 rounded-xl font-black text-2xl border border-zinc-200 dark:border-zinc-700">
                                                    {uniqueVoters} / {studentCount} Votes
                                                </span>
                                                <span className="bg-zinc-100 dark:bg-zinc-800/50 text-xs font-bold text-zinc-500 dark:text-zinc-400 uppercase tracking-wider px-4 py-2 rounded-lg flex items-center gap-2 border border-transparent dark:border-zinc-800">
                                                    {liveStudentCount} Online Now
                                                </span>
                                            </div>
                                        </div>
                                        
                                        {/* Simple visualization for Dashboard */}
                                        <div className="grid grid-cols-1 gap-8">
                                            {averages.map((cat, i) => (
                                                <div key={cat.id} className="bg-zinc-50 dark:bg-zinc-950/50 p-6 rounded-3xl border border-zinc-100 dark:border-zinc-800">
                                                    <div className="flex justify-between mb-4 items-center">
                                                        <span className="font-bold text-zinc-500 dark:text-zinc-400 text-xl uppercase flex items-center gap-3">
                                                            <div className={`w-4 h-4 rounded-full ${COLORS[i % COLORS.length]}`}></div>
                                                            {cat.name}
                                                        </span>
                                                        <span className="font-black text-zinc-900 dark:text-white text-3xl">{cat.avg} <span className="text-zinc-400 text-lg font-medium">/ {cat.max}</span></span>
                                                    </div>
                                                    <div className="h-6 bg-zinc-200 dark:bg-zinc-800 rounded-full overflow-hidden">
                                                        <div className={`h-full ${COLORS[i % COLORS.length]}`} style={{ width: `${(parseFloat(cat.avg) / cat.max) * 100}%` }} />
                                                    </div>
                                                </div>
                                            ))}
                                            {averages.length === 0 && (
                                                <div className="text-center text-zinc-400 font-bold italic py-10">Waiting for votes...</div>
                                            )}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="h-96 flex flex-col items-center justify-center text-zinc-300 dark:text-zinc-700">
                                        <div className="bg-zinc-50 dark:bg-zinc-800/50 p-8 rounded-full mb-6 scale-150">
                                            <IconPlay />
                                        </div>
                                        <span className="font-bold text-xl mb-4">Ready for next evaluation</span>
                                        <div className="bg-zinc-100 dark:bg-zinc-800/50 text-sm font-bold text-zinc-500 dark:text-zinc-400 uppercase tracking-widest px-6 py-3 rounded-2xl border border-transparent dark:border-zinc-800 flex items-center gap-3 animate-fadeIn">
                                            <span className="w-2 h-2 rounded-full bg-blue-500"></span>
                                            {liveStudentCount} {liveStudentCount === 1 ? 'Student' : 'Students'} Connected
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function StudentView({ gameState, isDark }) {
            const [submitted, setSubmitted] = useState(false);
            const [localSubject, setLocalSubject] = useState(''); // Tracks active subject to detect changes
            const [currentStepIndex, setCurrentStepIndex] = useState(0);
            const [allScores, setAllScores] = useState({}); // { "stepKey": { scores } }
            const [showResults, setShowResults] = useState(false);

            // Construct the steps based on mode
            const steps = useMemo(() => {
                if (!gameState || !gameState.isVotingOpen) return [];
                const s = [];
                const mode = gameState.votingMode;
                const participants = gameState.currentParticipants || [];

                if (mode === 'group' || mode === 'mixed') {
                    s.push({ type: 'group', name: gameState.currentSubject, label: 'Group Overall' });
                }
                if (mode === 'mixed' || mode === 'participants') {
                    participants.forEach(p => s.push({ type: 'participant', name: p, label: p }));
                }
                return s;
            }, [gameState]);

            useEffect(() => {
                if (!gameState) return;

                // 1. Detect New Subject
                // We check against a local state to prevent resetting form on every socket update (tick)
                if (gameState.currentSubject !== localSubject) {
                    setLocalSubject(gameState.currentSubject);
                    setSubmitted(false);
                    setAllScores({});
                    setCurrentStepIndex(0);
                    setShowResults(false); // Close results when subject changes
                } 
                
                // 2. Detect Voting Start Logic
                // If voting is OPEN and we haven't submitted yet, ensure we are not viewing results
                if (gameState.isVotingOpen && !submitted && showResults) {
                    setShowResults(false);
                }
            }, [gameState, localSubject, submitted, showResults]);

            if (!gameState || !gameState.sessionId) return <div className="min-h-screen flex items-center justify-center text-zinc-300 font-black text-xs uppercase tracking-[0.2em] animate-pulse">Syncing...</div>;

            // Show Results Overlay
            if (showResults) {
                return <ResultsView gameState={gameState} onClose={() => setShowResults(false)} />;
            }

            // Waiting Screen
            if (!gameState.isVotingOpen) return (
                <div className="min-h-screen flex items-center justify-center p-6 text-center">
                    <div className="max-w-xs animate-fadeIn bg-white dark:bg-zinc-900 p-8 rounded-3xl border-b border-zinc-200 dark:border-zinc-800">
                        <div className="text-zinc-300 dark:text-zinc-600 mb-6 flex justify-center scale-150"><IconStop /></div>
                        <h2 className="text-2xl font-black text-zinc-900 dark:text-white mb-2">Voting Closed</h2>
                        <p className="text-zinc-500 dark:text-zinc-400 font-medium leading-relaxed mb-8">Eyes on the board!<br/>Waiting for the next subject.</p>
                        
                        <button 
                            onClick={() => setShowResults(true)}
                            className="w-full bg-zinc-100 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-300 font-bold py-3 rounded-xl hover:bg-zinc-200 dark:hover:bg-zinc-700 transition flex items-center justify-center gap-2"
                        >
                            <IconList /> View Results
                        </button>
                    </div>
                </div>
            );

            // Success Screen
            if (submitted) return (
                <div className="min-h-screen flex flex-col items-center justify-center p-10 text-center animate-fadeIn">
                    <div className="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center text-white mb-8 animate-bounce">
                        <IconCheck />
                    </div>
                    <h2 className="text-4xl font-black text-zinc-900 dark:text-white mb-3">Sent!</h2>
                    <p className="text-zinc-400 font-bold text-lg mb-8">You're all set.</p>
                    <button 
                        onClick={() => setShowResults(true)}
                        className="bg-zinc-200 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-300 font-bold px-8 py-3 rounded-xl hover:bg-zinc-300 dark:hover:bg-zinc-700 transition flex items-center gap-2"
                    >
                        <IconList /> View Results
                    </button>
                </div>
            );

            // If no steps generated, something is wrong
            if (steps.length === 0) return <div className="min-h-screen flex items-center justify-center">Loading steps...</div>;

            const currentStep = steps[currentStepIndex];
            // Get scores for current step, or initialize with min values
            const currentScores = allScores[currentStepIndex] || gameState.categories.reduce((acc, c) => ({...acc, [c.id]: c.min}), {});

            const handleScoreChange = (catId, val) => {
                setAllScores(prev => ({
                    ...prev,
                    [currentStepIndex]: { ...currentScores, [catId]: val }
                }));
            };

            const goNext = () => {
                // Ensure current scores are saved even if untouched
                setAllScores(prev => ({
                    ...prev,
                    [currentStepIndex]: currentScores
                }));
                if (currentStepIndex < steps.length - 1) {
                    setCurrentStepIndex(currentStepIndex + 1);
                } else {
                    // Final Submit
                    // Transform map to array for server
                    const items = steps.map((step, idx) => ({
                        type: step.type,
                        name: step.name === gameState.currentSubject ? step.name : step.label, // use label for participant name
                        scores: allScores[idx] || gameState.categories.reduce((acc, c) => ({...acc, [c.id]: c.min}), {})
                    }));
                    
                    socket.emit('student-submit-vote', { items });
                    setSubmitted(true);
                    // localSubject already tracks current subject, no need to manually set lastSub
                }
            };

            const goBack = () => {
                 if (currentStepIndex > 0) setCurrentStepIndex(currentStepIndex - 1);
            };

            return (
                <div className="min-h-screen flex flex-col w-full max-w-7xl mx-auto bg-white dark:bg-zinc-900 transition-colors">
                    {/* Header */}
                    <div className="p-8 pt-12 bg-zinc-50 dark:bg-zinc-900 border-b border-zinc-100 dark:border-zinc-800">
                        <div className="flex justify-between items-center mb-4">
                            <span className="bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 px-3 py-1 rounded-full font-bold text-[10px] uppercase tracking-widest inline-block">
                                {currentStep.type === 'group' ? 'Group Assessment' : 'Individual Assessment'}
                            </span>
                            <span className="text-zinc-400 font-bold text-xs uppercase tracking-widest">
                                Step {currentStepIndex + 1} of {steps.length}
                            </span>
                        </div>
                        <h1 className="text-3xl font-black text-zinc-900 dark:text-white leading-tight break-words">{currentStep.label}</h1>
                    </div>

                    {/* Progress Bar */}
                    <div className="h-1 bg-zinc-100 dark:bg-zinc-800 w-full">
                        <div 
                            className="h-full bg-blue-500 transition-all duration-300" 
                            style={{ width: `${((currentStepIndex + 1) / steps.length) * 100}%` }} 
                        />
                    </div>

                    {/* Content */}
                    <div className="flex-1 p-8 overflow-y-auto">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {gameState.categories.map((cat, i) => {
                                const color = HEX_COLORS[i % HEX_COLORS.length];
                                const percent = ((currentScores[cat.id] - cat.min) / (cat.max - cat.min)) * 100;
                                const emptyColor = isDark ? '#3f3f46' : '#e4e4e7';
                                const backgroundStyle = {
                                    background: `linear-gradient(to right, ${color} 0%, ${color} ${percent}%, ${emptyColor} ${percent}%, ${emptyColor} 100%)`
                                };

                                return (
                                <div key={cat.id} className="animate-fadeIn p-6 bg-zinc-50 dark:bg-zinc-950/50 rounded-2xl border border-zinc-100 dark:border-zinc-800">
                                    <div className="flex justify-between items-center mb-6">
                                        <label className="font-bold text-lg text-zinc-700 dark:text-zinc-200 flex items-center gap-2">
                                            <div className={`w-3 h-3 rounded-full ${COLORS[i % COLORS.length]}`}></div>
                                            {cat.name}
                                        </label>
                                        <div className="bg-white dark:bg-zinc-900 px-4 py-2 rounded-xl border border-zinc-100 dark:border-zinc-700 shadow-sm">
                                            <span className="text-2xl font-black text-blue-600 dark:text-white tabular-nums">
                                                {currentScores[cat.id]}
                                            </span>
                                            <span className="text-zinc-400 text-xs font-bold ml-1 uppercase">/ {cat.max}</span>
                                        </div>
                                    </div>
                                    <input 
                                        type="range" 
                                        min={cat.min} 
                                        max={cat.max} 
                                        step="0.5" 
                                        value={currentScores[cat.id]} 
                                        onChange={e => handleScoreChange(cat.id, e.target.value)} 
                                        className="range-slider" 
                                        style={backgroundStyle}
                                    />
                                    <div className="flex justify-between text-[10px] font-bold text-zinc-400 mt-4 uppercase tracking-wider">
                                        <span>Poor ({cat.min})</span>
                                        <span>Excellent ({cat.max})</span>
                                    </div>
                                </div>
                            )})}
                        </div>
                    </div>

                    {/* Footer Nav */}
                    <div className="p-6 bg-white dark:bg-zinc-900 border-t border-zinc-100 dark:border-zinc-800 sticky bottom-0 z-10 flex gap-4">
                        {currentStepIndex > 0 && (
                            <button 
                                onClick={goBack}
                                className="flex-none w-16 bg-zinc-200 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-300 rounded-2xl flex items-center justify-center hover:bg-zinc-300 dark:hover:bg-zinc-700 transition"
                            >
                                <IconArrowLeft />
                            </button>
                        )}
                        <button 
                            onClick={goNext}
                            className="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-black text-xl py-5 rounded-2xl transition-all border-blue-800 flex items-center justify-center gap-3"
                        >
                            {currentStepIndex === steps.length - 1 ? (
                                <>SUBMIT <IconCheck /></>
                            ) : (
                                <>NEXT <IconArrowRight /></>
                            )}
                        </button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>